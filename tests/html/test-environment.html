<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPGA Pin Planner - テスト環境</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 8px;
            border-left: 4px solid #4A90E2;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .warning { border-left-color: #ffc107; }
        
        button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #4A90E2;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background-color: #357abd; }
        .danger { background-color: #dc3545; }
        .danger:hover { background-color: #c82333; }
        
        .log {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>🧪 FPGA Pin Planner - 統合テスト環境</h1>
    
    <div class="status-grid">
        <div class="status-card">
            <h3>🚀 開発サーバー</h3>
            <div id="server-status">確認中...</div>
            <button onclick="testServer()">サーバーテスト</button>
        </div>
        
        <div class="status-card">
            <h3>📊 CSV機能</h3>
            <div id="csv-status">未テスト</div>
            <button onclick="testCSV()">CSV機能テスト</button>
        </div>
        
        <div class="status-card">
            <h3>🏪 ストア状態</h3>
            <div id="store-status">未テスト</div>
            <button onclick="testStore()">ストアテスト</button>
        </div>
    </div>
    
    <div class="test-section">
        <h3>🔧 テスト操作</h3>
        <button onclick="openMainApp()">メインアプリを開く</button>
        <button onclick="openDevTools()">開発者ツールを開く</button>
        <button onclick="clearLogs()">ログクリア</button>
        <button onclick="runAllTests()" class="danger">全テスト実行</button>
    </div>
    
    <div class="test-section">
        <h3>📝 テストログ</h3>
        <div id="test-log" class="log">テスト開始を待機中...</div>
    </div>
    
    <div class="test-section">
        <h3>🔍 リアルタイム監視</h3>
        <div id="realtime-status" class="log">監視開始...</div>
    </div>

    <script>
        let logElement;
        let realtimeElement;
        
        document.addEventListener('DOMContentLoaded', () => {
            logElement = document.getElementById('test-log');
            realtimeElement = document.getElementById('realtime-status');
            
            log('🚀 テスト環境が初期化されました');
            startRealtimeMonitoring();
        });
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);
            
            if (logElement) {
                logElement.innerHTML += logEntry + '<br>';
                logElement.scrollTop = logElement.scrollHeight;
            }
        }
        
        function updateStatus(elementId, message, type = '') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.color = type === 'success' ? '#28a745' : 
                                    type === 'error' ? '#dc3545' : 
                                    type === 'warning' ? '#ffc107' : '#fff';
            }
        }
        
        async function testServer() {
            log('🔍 開発サーバーをテスト中...');
            updateStatus('server-status', 'テスト中...', '');
            
            try {
                const response = await fetch('http://localhost:5175');
                if (response.ok) {
                    updateStatus('server-status', '✅ 正常', 'success');
                    log('✅ 開発サーバー: 正常動作確認');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('server-status', '❌ エラー', 'error');
                log(`❌ 開発サーバー: ${error.message}`);
            }
        }
        
        async function testCSV() {
            log('📊 CSV機能をテスト中...');
            updateStatus('csv-status', 'テスト中...', '');
            
            try {
                // CSV読み込み機能のテスト
                const csvContent = 'Pin,Pin Name,Bank\\nA1,TEST_PIN,14\\nB1,TEST_PIN2,15';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const file = new File([blob], 'test.csv', { type: 'text/csv' });
                
                if (file.size > 0) {
                    updateStatus('csv-status', '✅ 正常', 'success');
                    log('✅ CSV機能: ファイル作成・読み込み正常');
                } else {
                    throw new Error('ファイル作成に失敗');
                }
            } catch (error) {
                updateStatus('csv-status', '❌ エラー', 'error');
                log(`❌ CSV機能: ${error.message}`);
            }
        }
        
        async function testStore() {
            log('🏪 ストア機能をテスト中...');
            updateStatus('store-status', 'テスト中...', '');
            
            try {
                // LocalStorageのテスト
                const testData = { test: 'data', timestamp: Date.now() };
                localStorage.setItem('fpga-test', JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem('fpga-test'));
                
                if (retrieved && retrieved.test === 'data') {
                    // Immer MapSet プラグインテスト
                    try {
                        const testSet = new Set([1, 2, 3]);
                        log('✅ Set操作テスト: ' + testSet.size + ' items');
                        const testMap = new Map([['key', 'value']]);
                        log('✅ Map操作テスト: ' + testMap.size + ' items');
                        
                        updateStatus('store-status', '✅ 正常', 'success');
                        log('✅ ストア機能: LocalStorage読み書き正常、Immer MapSet対応');
                    } catch (immerError) {
                        log('⚠️ Immer MapSet警告: ' + immerError.message);
                        updateStatus('store-status', '⚠️ 部分対応', 'warning');
                    }
                    localStorage.removeItem('fpga-test');
                } else {
                    throw new Error('データの整合性エラー');
                }
            } catch (error) {
                updateStatus('store-status', '❌ エラー', 'error');
                log(`❌ ストア機能: ${error.message}`);
            }
        }
        
        function openMainApp() {
            log('🚀 メインアプリケーションを開きます...');
            window.open('http://localhost:5175', '_blank');
        }
        
        function openDevTools() {
            log('🔧 開発者ツールを開く指示...');
            alert('F12キーまたは右クリック→検証でブラウザの開発者ツールを開いてください');
        }
        
        function clearLogs() {
            if (logElement) {
                logElement.innerHTML = '';
            }
            log('🗑️ ログがクリアされました');
        }
        
        async function runAllTests() {
            log('🔄 全テストを実行します...');
            await testServer();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCSV();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testStore();
            log('✅ 全テスト完了');
        }
        
        function startRealtimeMonitoring() {
            setInterval(() => {
                const now = new Date();
                const status = `監視中... ${now.toLocaleTimeString()}`;
                if (realtimeElement) {
                    realtimeElement.innerHTML = status + '<br>' + 
                        `サーバー状態: ${document.getElementById('server-status').textContent}<br>` +
                        `メモリ使用量: ${(performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2) + 'MB' : '不明')}`;
                }
            }, 1000);
        }
        
        // エラー監視
        window.addEventListener('error', (event) => {
            log(`❌ JavaScriptエラー: ${event.message} (${event.filename}:${event.lineno})`);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`❌ Promise拒否: ${event.reason}`);
        });
        
        // 初期テスト実行
        setTimeout(() => {
            testServer();
        }, 1000);
    </script>
</body>
</html>
