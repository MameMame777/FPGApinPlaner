<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPGA Pin Planner - Save Function Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        .debug-panel {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #1177bb;
        }
        .log {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ec9b0; }
        .error { color: #f44747; }
        .info { color: #569cd6; }
        .warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>🔧 FPGA Pin Planner - Save Function Debug</h1>
    
    <div class="debug-panel">
        <h2>Save Function Test</h2>
        <p>このページでセーブ機能をテストできます。VS Codeの開発者ツールコンソールも確認してください。</p>
        
        <button class="button" onclick="testSaveFunction()">📁 Test Save Dialog</button>
        <button class="button" onclick="testXDCExport()">⚡ Test XDC Export</button>
        <button class="button" onclick="testCSVExport()">📊 Test CSV Export</button>
        <button class="button" onclick="clearLog()">🗑️ Clear Log</button>
    </div>

    <div class="debug-panel">
        <h3>Debug Log</h3>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<span class="${logClass}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // Check if we're in VS Code
        function isInVSCode() {
            const result = typeof window.vscode !== 'undefined';
            log(`VS Code environment detected: ${result}`, result ? 'success' : 'warning');
            return result;
        }

        // Test save function with mock data
        async function testSaveFunction() {
            log('🔧 Starting save function test...', 'info');
            
            if (!isInVSCode()) {
                log('❌ Not in VS Code environment - save function will not work', 'error');
                return;
            }

            try {
                const testContent = `# Test XDC File
# Generated on ${new Date().toISOString()}
set_property PACKAGE_PIN A1 [get_ports clk]
set_property IOSTANDARD LVCMOS33 [get_ports clk]
`;

                log('📤 Sending save dialog request...', 'info');
                const result = await saveFileInVSCode(
                    testContent,
                    'test_constraints.xdc',
                    { 'XDC Files': ['xdc'], 'All Files': ['*'] },
                    'Save Test XDC File'
                );

                if (result) {
                    log('✅ Save operation completed successfully!', 'success');
                } else {
                    log('❌ Save operation failed or was cancelled', 'error');
                }
            } catch (error) {
                log(`❌ Error during save test: ${error}`, 'error');
            }
        }

        async function testXDCExport() {
            log('⚡ Testing XDC export...', 'info');
            await testSaveFunction();
        }

        async function testCSVExport() {
            log('📊 Testing CSV export...', 'info');
            
            const csvContent = `Pin,Signal,Package,Standard
A1,clk,BGA,LVCMOS33
B2,rst,BGA,LVCMOS33
C3,data[0],BGA,LVCMOS18
`;

            if (isInVSCode()) {
                const result = await saveFileInVSCode(
                    csvContent,
                    'pin_assignments.csv',
                    { 'CSV Files': ['csv'], 'All Files': ['*'] },
                    'Export Pin Assignments'
                );
                
                log(result ? '✅ CSV export successful' : '❌ CSV export failed', result ? 'success' : 'error');
            }
        }

        // Copy the exact saveFileInVSCode function from App.tsx
        const saveFileInVSCode = async (content, defaultFilename, filters, saveLabel) => {
            if (!isInVSCode()) {
                log('⚠️ Not in VS Code environment', 'warning');
                return false;
            }

            try {
                const vscode = window.vscode;
                log(`🔧 Starting save dialog with options: ${JSON.stringify({ saveLabel, filters, defaultFilename })}`, 'info');
                
                // Step 1: Show save dialog
                const uri = await new Promise((resolve) => {
                    const handler = (event) => {
                        log(`📨 Received message: ${JSON.stringify(event.data)}`, 'info');
                        if (event.data.command === 'saveDialogResult') {
                            window.removeEventListener('message', handler);
                            log(`📁 Save dialog resolved with: ${JSON.stringify(event.data.result)}`, 'info');
                            resolve(event.data.result);
                        }
                    };
                    window.addEventListener('message', handler);
                    
                    log('📤 Sending showSaveDialog message', 'info');
                    vscode.postMessage({
                        command: 'showSaveDialog',
                        options: {
                            saveLabel: saveLabel,
                            filters: filters,
                            defaultUri: vscode.Uri?.file?.(defaultFilename)
                        }
                    });
                });

                if (uri) {
                    log(`📁 Selected save location: ${JSON.stringify(uri)}`, 'success');
                    
                    // Step 2: Save file content
                    log('💾 Starting file save operation', 'info');
                    const saveResult = await new Promise((resolve) => {
                        const handler = (event) => {
                            log(`📨 Received save result message: ${JSON.stringify(event.data)}`, 'info');
                            if (event.data.command === 'saveFileResult') {
                                window.removeEventListener('message', handler);
                                log(`✅ Save operation resolved with: ${event.data.success}`, 'info');
                                resolve(event.data.success);
                            }
                        };
                        window.addEventListener('message', handler);
                        
                        log('📤 Sending saveFile message', 'info');
                        vscode.postMessage({
                            command: 'saveFile',
                            filePath: uri.toString(),
                            content: content,
                            filename: defaultFilename
                        });
                    });

                    log(`🎯 Final save result: ${saveResult}`, saveResult ? 'success' : 'error');
                    return saveResult;
                } else {
                    log('❌ No save location selected', 'warning');
                }
            } catch (error) {
                log(`❌ VS Code save failed: ${error}`, 'error');
            }
            return false;
        };

        // Initialize
        window.addEventListener('load', () => {
            log('🚀 Debug page loaded', 'success');
            isInVSCode();
            
            if (typeof window.vscode !== 'undefined') {
                log('✅ VS Code API available', 'success');
                window.vscode.postMessage({ command: 'appReady' });
            } else {
                log('⚠️ VS Code API not available - make sure to open this in VS Code webview', 'warning');
            }
        });
    </script>
</body>
</html>
