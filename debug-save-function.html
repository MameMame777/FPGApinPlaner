<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPGA Pin Planner - Save Function Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            margin: 0;
        }
        .debug-panel {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #1177bb;
        }
        .log {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #4ec9b0; }
        .error { color: #f44747; }
        .info { color: #569cd6; }
        .warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>ğŸ”§ FPGA Pin Planner - Save Function Debug</h1>
    
    <div class="debug-panel">
        <h2>Save Function Test</h2>
        <p>ã“ã®ãƒšãƒ¼ã‚¸ã§ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚VS Codeã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
        
        <button class="button" onclick="testSaveFunction()">ğŸ“ Test Save Dialog</button>
        <button class="button" onclick="testXDCExport()">âš¡ Test XDC Export</button>
        <button class="button" onclick="testCSVExport()">ğŸ“Š Test CSV Export</button>
        <button class="button" onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
    </div>

    <div class="debug-panel">
        <h3>Debug Log</h3>
        <div id="debugLog" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logElement.innerHTML += `<span class="${logClass}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // Check if we're in VS Code
        function isInVSCode() {
            const result = typeof window.vscode !== 'undefined';
            log(`VS Code environment detected: ${result}`, result ? 'success' : 'warning');
            return result;
        }

        // Test save function with mock data
        async function testSaveFunction() {
            log('ğŸ”§ Starting save function test...', 'info');
            
            if (!isInVSCode()) {
                log('âŒ Not in VS Code environment - save function will not work', 'error');
                return;
            }

            try {
                const testContent = `# Test XDC File
# Generated on ${new Date().toISOString()}
set_property PACKAGE_PIN A1 [get_ports clk]
set_property IOSTANDARD LVCMOS33 [get_ports clk]
`;

                log('ğŸ“¤ Sending save dialog request...', 'info');
                const result = await saveFileInVSCode(
                    testContent,
                    'test_constraints.xdc',
                    { 'XDC Files': ['xdc'], 'All Files': ['*'] },
                    'Save Test XDC File'
                );

                if (result) {
                    log('âœ… Save operation completed successfully!', 'success');
                } else {
                    log('âŒ Save operation failed or was cancelled', 'error');
                }
            } catch (error) {
                log(`âŒ Error during save test: ${error}`, 'error');
            }
        }

        async function testXDCExport() {
            log('âš¡ Testing XDC export...', 'info');
            await testSaveFunction();
        }

        async function testCSVExport() {
            log('ğŸ“Š Testing CSV export...', 'info');
            
            const csvContent = `Pin,Signal,Package,Standard
A1,clk,BGA,LVCMOS33
B2,rst,BGA,LVCMOS33
C3,data[0],BGA,LVCMOS18
`;

            if (isInVSCode()) {
                const result = await saveFileInVSCode(
                    csvContent,
                    'pin_assignments.csv',
                    { 'CSV Files': ['csv'], 'All Files': ['*'] },
                    'Export Pin Assignments'
                );
                
                log(result ? 'âœ… CSV export successful' : 'âŒ CSV export failed', result ? 'success' : 'error');
            }
        }

        // Copy the exact saveFileInVSCode function from App.tsx
        const saveFileInVSCode = async (content, defaultFilename, filters, saveLabel) => {
            if (!isInVSCode()) {
                log('âš ï¸ Not in VS Code environment', 'warning');
                return false;
            }

            try {
                const vscode = window.vscode;
                log(`ğŸ”§ Starting save dialog with options: ${JSON.stringify({ saveLabel, filters, defaultFilename })}`, 'info');
                
                // Step 1: Show save dialog
                const uri = await new Promise((resolve) => {
                    const handler = (event) => {
                        log(`ğŸ“¨ Received message: ${JSON.stringify(event.data)}`, 'info');
                        if (event.data.command === 'saveDialogResult') {
                            window.removeEventListener('message', handler);
                            log(`ğŸ“ Save dialog resolved with: ${JSON.stringify(event.data.result)}`, 'info');
                            resolve(event.data.result);
                        }
                    };
                    window.addEventListener('message', handler);
                    
                    log('ğŸ“¤ Sending showSaveDialog message', 'info');
                    vscode.postMessage({
                        command: 'showSaveDialog',
                        options: {
                            saveLabel: saveLabel,
                            filters: filters,
                            defaultUri: vscode.Uri?.file?.(defaultFilename)
                        }
                    });
                });

                if (uri) {
                    log(`ğŸ“ Selected save location: ${JSON.stringify(uri)}`, 'success');
                    
                    // Step 2: Save file content
                    log('ğŸ’¾ Starting file save operation', 'info');
                    const saveResult = await new Promise((resolve) => {
                        const handler = (event) => {
                            log(`ğŸ“¨ Received save result message: ${JSON.stringify(event.data)}`, 'info');
                            if (event.data.command === 'saveFileResult') {
                                window.removeEventListener('message', handler);
                                log(`âœ… Save operation resolved with: ${event.data.success}`, 'info');
                                resolve(event.data.success);
                            }
                        };
                        window.addEventListener('message', handler);
                        
                        log('ğŸ“¤ Sending saveFile message', 'info');
                        vscode.postMessage({
                            command: 'saveFile',
                            filePath: uri.toString(),
                            content: content,
                            filename: defaultFilename
                        });
                    });

                    log(`ğŸ¯ Final save result: ${saveResult}`, saveResult ? 'success' : 'error');
                    return saveResult;
                } else {
                    log('âŒ No save location selected', 'warning');
                }
            } catch (error) {
                log(`âŒ VS Code save failed: ${error}`, 'error');
            }
            return false;
        };

        // Initialize
        window.addEventListener('load', () => {
            log('ğŸš€ Debug page loaded', 'success');
            isInVSCode();
            
            if (typeof window.vscode !== 'undefined') {
                log('âœ… VS Code API available', 'success');
                window.vscode.postMessage({ command: 'appReady' });
            } else {
                log('âš ï¸ VS Code API not available - make sure to open this in VS Code webview', 'warning');
            }
        });
    </script>
</body>
</html>
