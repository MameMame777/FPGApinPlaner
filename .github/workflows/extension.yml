name: VS Code Extension

on:
  push:
    branches: [ master ]
    paths: 
      - 'vscode-extension/**'
  pull_request:
    branches: [ master ]
    paths:
      - 'vscode-extension/**'
  workflow_dispatch:

jobs:
  build-extension:
    name: Build VS Code Extension
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ—ï¸ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
        sudo apt-get install -y xvfb
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: ðŸ“¦ Install main app dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build main application first
      run: npm run build
      
    - name: ðŸ“¦ Install extension dependencies
      working-directory: vscode-extension
      run: npm ci
      
    - name: ðŸ” Type check extension
      working-directory: vscode-extension
      run: npm run compile
      
    - name: ðŸ§ª Run tests
      working-directory: vscode-extension
      run: |
        # Skip tests for now as no test files exist
        echo "Skipping tests - no test files found"
      continue-on-error: true
      
    - name: ðŸ“¦ Package extension
      working-directory: vscode-extension
      run: |
        npm install -g @vscode/vsce
        vsce package
        
    - name: ðŸ“¤ Upload VSIX
      uses: actions/upload-artifact@v4
      with:
        name: vscode-extension
        path: vscode-extension/*.vsix
        retention-days: 7
        
    - name: ðŸ“ Extension info
      working-directory: vscode-extension
      run: |
        echo "## ðŸ§© VS Codeæ‹¡å¼µæ©Ÿèƒ½ãƒ“ãƒ«ãƒ‰å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
        ls -la *.vsix >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•" >> $GITHUB_STEP_SUMMARY
        echo "1. Artifactsã‹ã‚‰ \`.vsix\` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
        echo "2. VS Codeã§ \`Extensions: Install from VSIX...\` ã‚’å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠž" >> $GITHUB_STEP_SUMMARY

  publish-extension:
    name: Publish to Marketplace
    runs-on: ubuntu-latest
    needs: build-extension
    if: github.ref == 'refs/heads/master' && contains(github.event.head_commit.message, 'release:')
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ—ï¸ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: ðŸ“¦ Install main app dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build main application first
      run: npm run build
        
    - name: ðŸ“¦ Install extension dependencies
      working-directory: vscode-extension
      run: npm ci
      
    - name: ðŸš€ Publish to Marketplace
      working-directory: vscode-extension
      run: |
        npm install -g @vscode/vsce
        vsce publish
      env:
        VSCE_PAT: ${{ secrets.VSCE_PAT }}
        
    - name: ðŸ“ Publish summary
      run: |
        echo "## ðŸŽ‰ VS Codeæ‹¡å¼µæ©Ÿèƒ½ã‚’å…¬é–‹ã—ã¾ã—ãŸï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Marketplace**: [FPGA Pin Planner](https://marketplace.visualstudio.com/items?itemName=MameMame777.fpga-pin-planner)" >> $GITHUB_STEP_SUMMARY
        echo "- **å…¬é–‹æ™‚åˆ»**: $(date)" >> $GITHUB_STEP_SUMMARY
