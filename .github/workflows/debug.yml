name: Debug CI/CD

on:
  workflow_dispatch:
    inputs:
      debug_level:
        description: 'Debug level'
        required: true
        default: 'info'
        type: choice
        options:
        - 'info'
        - 'debug'
        - 'verbose'
      test_component:
        description: 'Test specific component'
        required: false
        default: 'all'
        type: choice
        options:
        - 'all'
        - 'build'
        - 'pages'
        - 'tests'
        - 'security'

env:
  DEBUG: ${{ github.event.inputs.debug_level }}

jobs:
  debug-info:
    name: Debug Information
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ” Environment Debug
      run: |
        echo "## ðŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ åŸºæœ¬æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Debug Level**: ${{ github.event.inputs.debug_level }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Component**: ${{ github.event.inputs.test_component }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“ Repository Structure
      run: |
        echo "### ðŸ“ ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ " >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        find . -type f -name "*.json" -o -name "*.yml" -o -name "*.yaml" -o -name "*.md" | head -20 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“¦ Package.json Check
      run: |
        echo "### ðŸ“¦ package.json ã®å†…å®¹" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
        cat package.json | jq '.scripts' >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ”§ Node.js Setup
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“Š Dependencies Check
      run: |
        echo "### ðŸ“Š ä¾å­˜é–¢ä¿‚ã®çŠ¶æ…‹" >> $GITHUB_STEP_SUMMARY
        npm list --depth=0 >> $GITHUB_STEP_SUMMARY 2>&1 || true
        echo "" >> $GITHUB_STEP_SUMMARY

  test-build:
    name: Test Build Process
    runs-on: ubuntu-latest
    if: github.event.inputs.test_component == 'all' || github.event.inputs.test_component == 'build'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: |
        echo "Installing dependencies..."
        npm ci --verbose
        
    - name: ðŸ” Type check
      run: |
        echo "Running type check..."
        npm run type-check
        
    - name: ðŸ—ï¸ Build
      run: |
        echo "Building application..."
        npm run build
        
    - name: ðŸ“ Build Output Check
      run: |
        echo "## ðŸ—ï¸ ãƒ“ãƒ«ãƒ‰çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -la dist/ >> $GITHUB_STEP_SUMMARY 2>&1 || echo "dist ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  test-pages:
    name: Test Pages Deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.test_component == 'all' || github.event.inputs.test_component == 'pages'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install and Build
      run: |
        npm ci
        npm run build
        
    - name: ðŸ“ Test Pages Setup
      run: |
        echo "Testing Pages configuration..."
        
        # Test if Pages can be configured
        echo "## ðŸ“„ Pages ãƒ†ã‚¹ãƒˆçµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if dist directory exists
        if [ -d "dist" ]; then
          echo "âœ… dist ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la dist/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ dist ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Check for article file
        if [ -f "qiita-article.md" ]; then
          echo "âœ… qiita-article.md ãŒå­˜åœ¨ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ qiita-article.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
        fi

  test-permissions:
    name: Test Repository Permissions
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ” Check Permissions
      run: |
        echo "## ðŸ” æ¨©é™ãƒã‚§ãƒƒã‚¯çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ GitHub Token æ¨©é™" >> $GITHUB_STEP_SUMMARY
        echo "- **contents**: ${{ github.token && 'read' || 'none' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **pages**: checking..." >> $GITHUB_STEP_SUMMARY
        echo "- **id-token**: checking..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— å‚è€ƒãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- [Repository Settings](https://github.com/${{ github.repository }}/settings)" >> $GITHUB_STEP_SUMMARY
        echo "- [Pages Settings](https://github.com/${{ github.repository }}/settings/pages)" >> $GITHUB_STEP_SUMMARY
        echo "- [Actions Settings](https://github.com/${{ github.repository }}/settings/actions)" >> $GITHUB_STEP_SUMMARY

  debug-summary:
    name: Debug Summary
    runs-on: ubuntu-latest
    needs: [debug-info, test-build, test-pages, test-permissions]
    if: always()
    
    steps:
    - name: ðŸ“‹ Create Debug Report
      run: |
        echo "## ðŸŽ¯ ãƒ‡ãƒãƒƒã‚°ã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… å®Œäº†ã—ãŸãƒ†ã‚¹ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "- Debug Info: ${{ needs.debug-info.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Build Test: ${{ needs.test-build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Pages Test: ${{ needs.test-pages.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Permissions: ${{ needs.test-permissions.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        echo "1. å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã®ãƒ­ã‚°ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
        echo "2. Repository ã® Pages è¨­å®šã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
        echo "3. å¿…è¦ã«å¿œã˜ã¦ Secrets ã‚’è¨­å®š" >> $GITHUB_STEP_SUMMARY
