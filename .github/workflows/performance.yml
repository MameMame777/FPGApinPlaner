name: Performance Testing

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * 0' # æ¯Žé€±æ—¥æ›œæ—¥æ­£åˆ

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build
      run: npm run build
      
    - name: ðŸš€ Start server
      run: |
        npx serve -s dist -p 3000 &
        sleep 5
      
    - name: ðŸ” Run Lighthouse
      run: |
        npm install -g lighthouse
        lighthouse http://localhost:3000 --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless --no-sandbox"
        lighthouse http://localhost:3000 --output=html --output-path=./lighthouse-report.html --chrome-flags="--headless --no-sandbox"
        
    - name: ðŸ“Š Upload Lighthouse reports
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-reports
        path: |
          lighthouse-report.json
          lighthouse-report.html
        retention-days: 7
        
    - name: ðŸ“ Performance summary
      run: |
        echo "## âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ç›£æŸ»çµæžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Extract scores from Lighthouse JSON
        PERFORMANCE=$(cat lighthouse-report.json | grep -o '"performance":[0-9.]*' | cut -d':' -f2)
        ACCESSIBILITY=$(cat lighthouse-report.json | grep -o '"accessibility":[0-9.]*' | cut -d':' -f2)
        BEST_PRACTICES=$(cat lighthouse-report.json | grep -o '"best-practices":[0-9.]*' | cut -d':' -f2)
        SEO=$(cat lighthouse-report.json | grep -o '"seo":[0-9.]*' | cut -d':' -f2)
        
        echo "### ðŸ“Š Lighthouse ã‚¹ã‚³ã‚¢" >> $GITHUB_STEP_SUMMARY
        echo "- **Performance**: ${PERFORMANCE:-N/A}" >> $GITHUB_STEP_SUMMARY
        echo "- **Accessibility**: ${ACCESSIBILITY:-N/A}" >> $GITHUB_STEP_SUMMARY
        echo "- **Best Practices**: ${BEST_PRACTICES:-N/A}" >> $GITHUB_STEP_SUMMARY
        echo "- **SEO**: ${SEO:-N/A}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã¯ Artifacts ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: ðŸ“¦ Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build and analyze
      run: |
        npm run build
        
        # Bundle size analysis
        echo "## ðŸ“¦ ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºåˆ†æž" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º" >> $GITHUB_STEP_SUMMARY
        du -sh dist/* | sort -hr >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ˆ ç·ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚º" >> $GITHUB_STEP_SUMMARY
        echo "$(du -sh dist | cut -f1)" >> $GITHUB_STEP_SUMMARY
