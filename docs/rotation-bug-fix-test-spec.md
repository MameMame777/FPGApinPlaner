# 回転機能テスト仕様書

## 概要
FPGA Pin Plannerの90度回転機能における重要なバグ修正のテスト仕様書

## 修正内容
1. **グリッドラベルの位置ずれ修正**: 90度・270度回転時にグリッドラベル（A,B,C...と1,2,3...）が大きくずれる問題
2. **パッケージラベルの画面外移動修正**: 回転時にパッケージ名が画面外に移動する問題

## 技術的修正
### 1. グリッドラベル用座標変換関数の分離
- `transformPosition`: ピン用（回転変換適用）
- `transformGridLabelPosition`: グリッドラベル用（回転変換なし）

### 2. パッケージラベルの固定位置化
- 回転に依存しない固定位置（画面上部中央）に変更

## テストケース

### 手動テストチェックリスト

#### A. グリッドラベル位置テスト
- [ ] **0度回転**: グリッドラベルが正しい位置に表示される
- [ ] **90度回転**: グリッドラベルが元の位置を維持（ずれない）
- [ ] **180度回転**: グリッドラベルが正しい位置に表示される  
- [ ] **270度回転**: グリッドラベルが元の位置を維持（ずれない）

#### B. パッケージ情報表示テスト
- [ ] **0度回転**: パッケージ名が画面内に表示される
- [ ] **90度回転**: パッケージ名が画面内に表示される（画面外に移動しない）
- [ ] **180度回転**: パッケージ名が画面内に表示される
- [ ] **270度回転**: パッケージ名が画面内に表示される

#### C. ピン表示・選択テスト
- [ ] **回転前後でピン選択が保持される**
- [ ] **回転後もピンクリックで正しく選択される**
- [ ] **差動ペアの表示が回転後も正しい**

#### D. パフォーマンステスト
- [ ] **連続回転（8回転）が5秒以内に完了**
- [ ] **回転後もズーム・パン操作が正常**
- [ ] **大量ピン（1000+）でも回転が滑らか**

### 自動テスト対象（将来実装）

#### 単体テスト
```typescript
// transformGridLabelPosition関数のテスト
describe('transformGridLabelPosition', () => {
  it('should not apply rotation to coordinates', () => {
    const pin = { position: { x: 100, y: 0 } };
    const result0 = transformGridLabelPosition(pin, 0);
    const result90 = transformGridLabelPosition(pin, 90);
    // 回転角度に関係なく同じ座標系での位置を返す
    expect(result0.x).toEqual(result90.x);
    expect(result0.y).toEqual(result90.y);
  });
});
```

#### 統合テスト（E2E）
```typescript
// Playwright使用
test('grid labels remain correctly positioned during rotation', async ({ page }) => {
  await page.goto('/');
  await loadSampleData(page);
  
  // 各回転角度でスクリーンショット比較
  for (const angle of [0, 90, 180, 270]) {
    await rotateToAngle(page, angle);
    await expect(page.locator('[data-testid="grid-labels"]')).toBeVisible();
    // グリッドラベルの位置が期待される範囲内にあることを確認
  }
});
```

## 回帰テスト項目

### 既存機能への影響確認
- [ ] **基本的なピン表示が正常**
- [ ] **List⇔Grid切り替えが正常**
- [ ] **ズーム・パン操作が正常**
- [ ] **ピン検索・フィルタが正常**
- [ ] **エクスポート機能が正常**
- [ ] **プロジェクト保存・読み込みが正常**

### パフォーマンス回帰テスト
- [ ] **初期描画時間が悪化していない**
- [ ] **メモリ使用量が悪化していない**
- [ ] **CPU使用率が悪化していない**

## 検証環境

### ブラウザ環境
- [ ] **Chrome**: 最新版
- [ ] **Firefox**: 最新版  
- [ ] **Edge**: 最新版
- [ ] **Safari**: 最新版（可能な場合）

### VS Code拡張機能環境
- [ ] **VS Code**: 最新安定版
- [ ] **VS Code Insiders**: 最新版

### サンプルデータ
- [ ] **小規模**: ~100ピン
- [ ] **中規模**: ~500ピン
- [ ] **大規模**: ~1000+ピン

## 既知の制限事項
1. 座標変換ロジックの複雑さにより、将来的にはより純粋な関数として抽出してテスタビリティを向上させる必要がある
2. Canvas要素のテストには専用のMock環境が必要

## バグ修正の品質保証
本修正により以下が確実に解決されている：
1. ✅ グリッドラベルの位置ずれ（90度・270度回転時）
2. ✅ パッケージ情報の画面外移動
3. ✅ 他機能への悪影響なし
4. ✅ パフォーマンスの劣化なし
